name: Basic CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

# No global KBUILD_OUTPUT - let the Makefile handle output organization

jobs:
  basic-build-and-test:
    name: Basic Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup basic environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            linux-headers-generic \
            python3 \
            python3-pip \
            curl
          
          echo "System info:"
          uname -a
          gcc --version
          python3 --version

      - name: Build kernel modules
        run: |
          echo "Building Canon R5 driver modules..."
          make clean
          make modules
          
          echo "Checking built modules..."
          ls -la *.ko || echo "No modules found"
          
          # Basic module validation
          for module in *.ko; do
            if [ -f "$module" ]; then
              echo "Module info for $(basename "$module"):"
              modinfo "$module" || echo "Could not get module info"
            fi
          done

      - name: Run basic tests
        run: |
          echo "Running basic test suite..."
          
          # Make test scripts executable
          chmod +x tests/integration/*.sh || echo "No test scripts found"
          
          # Run dependency tests (non-privileged parts only)
          if [ -f tests/integration/test_dependencies.sh ]; then
            echo "Running dependency validation..."
            tests/integration/test_dependencies.sh || echo "Dependency tests completed with warnings"
          fi

      - name: Basic security scan
        run: |
          echo "Running basic security checks..."
          
          # Check for obvious security issues
          echo "Checking for hardcoded secrets..."
          if grep -r -i "password\|secret\|key" drivers/ include/ | grep -v "\.ko\|\.o" | head -5; then
            echo "⚠️  Found potential hardcoded secrets - please review"
          else
            echo "✅ No obvious hardcoded secrets found"
          fi
          
          # Check file permissions
          echo "Checking file permissions..."
          find . -name "*.sh" -not -perm -u+x | head -5 | while read file; do
            echo "⚠️  Script not executable: $file"
          done || echo "✅ Script permissions look good"

      - name: Generate basic report
        if: always()
        run: |
          echo "## Basic CI Report" > ci-report.txt
          echo "Generated: $(date)" >> ci-report.txt
          echo "" >> ci-report.txt
          
          echo "### Build Status" >> ci-report.txt
          if ls *.ko >/dev/null 2>&1; then
            echo "✅ Modules built successfully" >> ci-report.txt
            echo "Built modules:" >> ci-report.txt
            ls -1 *.ko | while read module; do
              echo "- $(basename "$module")" >> ci-report.txt
            done
          else
            echo "❌ No modules were built" >> ci-report.txt
          fi
          
          echo "" >> ci-report.txt
          echo "### System Info" >> ci-report.txt
          echo "- Kernel: $(uname -r)" >> ci-report.txt
          echo "- Compiler: $(gcc --version | head -1)" >> ci-report.txt
          echo "- Architecture: $(uname -m)" >> ci-report.txt
          
          cat ci-report.txt

      - name: Upload basic results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: basic-ci-results
          path: |
            ci-report.txt
            *.ko
            build/modules/
          retention-days: 7

  basic-security:
    name: Basic Security Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install security tools
        run: |
          set -euo pipefail
          echo "Resolving latest GitLeaks download URL..."
          LATEST_URL=""
          # Try GitHub API resolution
          if command -v curl >/dev/null 2>&1; then
            LATEST_URL=$(curl -fsSL https://api.github.com/repos/gitleaks/gitleaks/releases/latest \
              | grep -E 'browser_download_url' \
              | grep -Ei 'linux.*(x64|x86_64|amd64).*\.tar\.gz' \
              | cut -d '"' -f4 \
              | head -n1 || true)
          fi
          # Fallback to latest/download stable asset naming
          if [ -z "$LATEST_URL" ]; then
            # Map architecture (default to x64 on x86_64)
            ARCH="x64"
            if uname -m | grep -qiE 'aarch64|arm64'; then ARCH="arm64"; fi
            LATEST_URL="https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_linux_${ARCH}.tar.gz"
            echo "Using fallback URL: $LATEST_URL"
          else
            echo "Resolved URL: $LATEST_URL"
          fi
          # Download and extract
          wget -q -O gitleaks.tar.gz "$LATEST_URL" || { echo "Failed to download GitLeaks"; exit 1; }
          tar -xzf gitleaks.tar.gz || { echo "Failed to extract GitLeaks"; exit 1; }
          chmod +x gitleaks || true

      - name: Run GitLeaks
        run: |
          echo "Running GitLeaks secret detection..."
          ./gitleaks detect --source . --config .gitleaks.toml --verbose --no-git --exit-code 0 || echo "GitLeaks scan completed"

      - name: Basic file checks
        run: |
          echo "Running basic file security checks..."
          
          # Check for suspicious file extensions
          find . -name "*.key" -o -name "*.pem" -o -name "*.p12" -o -name "*.pfx" | while read file; do
            echo "⚠️  Potential key file found: $file"
          done || echo "✅ No key files found"
          
          # Check for large files that might be accidentally committed
          find . -size +1M -type f | grep -v "\.git\|build/" | while read file; do
            echo "⚠️  Large file found: $file ($(du -h "$file" | cut -f1))"
          done || echo "✅ No large files found"

      - name: Upload security results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: basic-security-results
          path: |
            gitleaks-report.json
          retention-days: 7

  summary:
    name: Basic CI Summary
    runs-on: ubuntu-latest
    needs: [basic-build-and-test, basic-security]
    if: always()
    
    steps:
      - name: Basic CI Summary
        run: |
          echo "## Canon R5 Driver Basic CI Summary"
          echo "===================================="
          
          echo "Build Status: ${{ needs.basic-build-and-test.result }}"
          echo "Security Status: ${{ needs.basic-security.result }}"
          
          if [[ "${{ needs.basic-build-and-test.result }}" == "success" && "${{ needs.basic-security.result }}" == "success" ]]; then
            echo "✅ Basic CI checks passed"
            exit 0
          else
            echo "❌ Some basic CI checks failed"
            exit 1
          fi
